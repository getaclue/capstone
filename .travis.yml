sudo: required
dist: trusty

services:
  - postgresql
  - redis-server

language: ruby

rvm:
  - 2.3.1

node_js:
  - "6"

before_install:
  - gem install bundler --no-rdoc --no-ri
  - npm install -g bower phantomjs-prebuilt

install:
  - cd Rails
  - bundle install
  - cd ../Ember/
  - npm install
  - bower install
  - npm install -g ember-cli
  - ember --version
  - cd ..

script:
  - cd Rails
  - bundle exec rake db:drop db:create db:migrate
  - bundle exec rspec
  - cd ../Ember/
  - ember test
  - cd ..

# based on https://neilmiddleton.github.io/deploying-to-heroku-from-travis-ci/
# https://blog.travis-ci.com/after_script_behavior_changes/
# https://docs.travis-ci.com/user/environment-variables/
# https://docs.travis-ci.com/user/customizing-the-build/
after_success:
  - wget -O- https://toolbelt.heroku.com/install-ubuntu.sh | sh
  - heroku --version
  - echo "Host heroku.com" >> ~/.ssh/config
  - echo "   StrictHostKeyChecking no" >> ~/.ssh/config
  - echo "   CheckHostIP no" >> ~/.ssh/config
  - echo "   UserKnownHostsFile=/dev/null" >> ~/.ssh/config
  - sh $TRAVIS_BUILD_DIR/build.sh

cache:
  bundler: true
  directories:
    - Ember/node_modules
    - Ember/bower_components

branches:
  except:
    - testing-production-building

# safelist
# branches:
#   only:
#   - master
#   - appt_resource
